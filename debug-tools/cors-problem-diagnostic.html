<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CORS Problem Diagnostic</title>
    <style>
        body { font-family: 'Kanit', sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .warning { background: #fff3cd; border-color: #ffeaa7; color: #856404; }
        .info { background: #cce7ff; border-color: #b3d7ff; color: #004085; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto; border-left: 4px solid #007bff; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .log { min-height: 100px; border: 1px solid #ddd; padding: 10px; margin-top: 10px; font-family: monospace; font-size: 12px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üö® CORS Problem Diagnostic Tool</h1>
        
        <div class="test-section info">
            <h3>üìã Current Status</h3>
            <div id="status-log" class="log">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...</div>
        </div>

        <div class="test-section">
            <h3>üß™ Test 1: Basic CORS Check</h3>
            <button onclick="testBasicCORS()">‡∏ó‡∏î‡∏™‡∏≠‡∏ö Basic CORS</button>
            <div id="basic-cors-log" class="log"></div>
        </div>

        <div class="test-section">
            <h3>üîç Test 2: Detailed API Testing</h3>
            <button onclick="testDetailedAPI()">‡∏ó‡∏î‡∏™‡∏≠‡∏ö API ‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
            <div id="detailed-api-log" class="log"></div>
        </div>

        <div class="test-section">
            <h3>üé≠ Test 3: Simulated Angular Request</h3>
            <button onclick="simulateAngularRequest()">‡∏à‡∏≥‡∏•‡∏≠‡∏á Angular Request</button>
            <div id="angular-sim-log" class="log"></div>
        </div>

        <div class="test-section">
            <h3>üì± Test 4: POST Request Test</h3>
            <button onclick="testPOSTRequest()">‡∏ó‡∏î‡∏™‡∏≠‡∏ö POST Request</button>
            <div id="post-test-log" class="log"></div>
        </div>

        <div class="test-section">
            <h3>üîß Solutions & Fixes</h3>
            <div id="solutions-log" class="log">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏±‡∏ô tests ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏Å‡πà‡∏≠‡∏ô...</div>
        </div>
    </div>

    <script>
        const STOCK_API = 'https://script.google.com/macros/s/AKfycbwSSJK8GTNP1D4VS-PF6XDZg4c_PDd4RQxj7hXE3Udxck_SwKWPPApuKORGFTF3wNdB/exec';
        const AUTH_API = 'https://script.google.com/macros/s/AKfycbw7-F46lou4iiIg0_JOldcsLiUUib2XO_EZXiQ90U4shMdRz-VY1mkTYqno2rf5NU2w/exec';

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const typeIcon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : 'üìù';
            element.innerHTML += `[${timestamp}] ${typeIcon} ${message}\n`;
            element.scrollTop = element.scrollHeight;
        }

        function clearLog(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        async function testBasicCORS() {
            clearLog('basic-cors-log');
            log('basic-cors-log', '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö Basic CORS...');
            
            try {
                // Test simple GET request
                log('basic-cors-log', '‡∏ó‡∏î‡∏™‡∏≠‡∏ö Stock API...');
                const response = await fetch(STOCK_API, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                log('basic-cors-log', `Status: ${response.status}`, response.ok ? 'success' : 'error');
                log('basic-cors-log', `URL: ${response.url}`);
                log('basic-cors-log', `Type: ${response.type}`);
                
                // Check CORS headers
                const corsOrigin = response.headers.get('access-control-allow-origin');
                log('basic-cors-log', `CORS Origin: ${corsOrigin || '‡πÑ‡∏°‡πà‡∏û‡∏ö'}`, corsOrigin ? 'success' : 'error');
                
                if (response.ok) {
                    const text = await response.text();
                    log('basic-cors-log', `Response length: ${text.length} characters`, 'success');
                    log('basic-cors-log', `Response preview: ${text.substring(0, 200)}...`);
                } else {
                    log('basic-cors-log', 'Response ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
                }
                
            } catch (error) {
                log('basic-cors-log', `‡πÄ‡∏Å‡∏¥‡∏î Error: ${error.name}`, 'error');
                log('basic-cors-log', `Message: ${error.message}`, 'error');
                
                if (error.message.includes('CORS')) {
                    log('basic-cors-log', 'üö® ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤ CORS!', 'error');
                    log('solutions-log', 'üí° ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç CORS: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google Apps Script deployment');
                }
            }
        }

        async function testDetailedAPI() {
            clearLog('detailed-api-log');
            log('detailed-api-log', '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö API ‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î...');
            
            const apis = [
                { name: 'Stock API', url: STOCK_API },
                { name: 'Auth API', url: AUTH_API }
            ];

            for (const api of apis) {
                log('detailed-api-log', `‡∏ó‡∏î‡∏™‡∏≠‡∏ö ${api.name}...`);
                
                try {
                    // Test with different methods and headers
                    const tests = [
                        { method: 'GET', headers: {} },
                        { method: 'GET', headers: { 'Content-Type': 'application/json' } },
                        { method: 'GET', headers: { 'Accept': 'application/json' } },
                        { method: 'OPTIONS', headers: {} }
                    ];

                    for (const test of tests) {
                        try {
                            const response = await fetch(api.url, {
                                method: test.method,
                                headers: test.headers,
                                mode: 'cors'
                            });
                            
                            log('detailed-api-log', `${test.method} ‚Üí Status: ${response.status}`, response.ok ? 'success' : 'warning');
                        } catch (e) {
                            log('detailed-api-log', `${test.method} ‚Üí Error: ${e.message}`, 'error');
                        }
                    }
                } catch (error) {
                    log('detailed-api-log', `${api.name} failed: ${error.message}`, 'error');
                }
            }
        }

        async function simulateAngularRequest() {
            clearLog('angular-sim-log');
            log('angular-sim-log', '‡∏à‡∏≥‡∏•‡∏≠‡∏á Angular HttpClient request...');
            
            try {
                // Simulate exact Angular HttpClient behavior
                const response = await fetch(STOCK_API, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json, text/plain, */*',
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin',
                    mode: 'cors'
                });

                log('angular-sim-log', `Angular-style request: ${response.status}`, response.ok ? 'success' : 'error');
                
                // Check all response headers
                log('angular-sim-log', 'Response Headers:');
                for (const [key, value] of response.headers.entries()) {
                    log('angular-sim-log', `  ${key}: ${value}`);
                }

                if (response.ok) {
                    const data = await response.text();
                    log('angular-sim-log', `Data received: ${data.length} chars`, 'success');
                } else {
                    log('angular-sim-log', 'Failed to get data', 'error');
                }

            } catch (error) {
                log('angular-sim-log', `Simulation failed: ${error.message}`, 'error');
                
                // Provide specific solutions based on error
                if (error.message.includes('CORS')) {
                    log('solutions-log', 'üîß CORS Error Solution:');
                    log('solutions-log', '1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Google Apps Script deployment settings');
                    log('solutions-log', '2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö "Execute the app as" ‡πÅ‡∏•‡∏∞ "Who has access"');
                    log('solutions-log', '3. ‡πÉ‡∏ä‡πâ credentials: "omit" ‡πÅ‡∏ó‡∏ô "same-origin"');
                }
            }
        }

        async function testPOSTRequest() {
            clearLog('post-test-log');
            log('post-test-log', '‡∏ó‡∏î‡∏™‡∏≠‡∏ö POST request ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Authentication...');
            
            const testData = {
                username: 'test',
                password: 'test',
                action: 'login'
            };

            try {
                const response = await fetch(AUTH_API, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(testData),
                    mode: 'cors'
                });

                log('post-test-log', `POST Status: ${response.status}`, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    const result = await response.text();
                    log('post-test-log', `POST Response: ${result.substring(0, 200)}...`, 'success');
                } else {
                    log('post-test-log', 'POST request failed', 'error');
                }

            } catch (error) {
                log('post-test-log', `POST Error: ${error.message}`, 'error');
                
                if (error.message.includes('CORS')) {
                    log('solutions-log', 'üîß POST CORS Solution:');
                    log('solutions-log', '1. Google Apps Script ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö POST method');
                    log('solutions-log', '2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö doPost() function ‡πÉ‡∏ô Google Apps Script');
                    log('solutions-log', '3. Return proper CORS headers in doPost response');
                }
            }
        }

        // Auto-run status check on page load
        window.onload = () => {
            log('status-log', `Browser: ${navigator.userAgent}`);
            log('status-log', `Location: ${window.location.origin}`);
            log('status-log', `Online: ${navigator.onLine ? 'Yes' : 'No'}`);
            log('status-log', 'Ready for CORS testing!');
        };
    </script>
</body>
</html>
